<!-- PÃ¡gina html que lista los svgs de un bucket de s3 y los muestra, permitiendo cambiar el color del svg. -->
<html>
<head>
    <title>SVGs</title>
    <meta charset="utf-8">
    <style>
        body {
            background-color: #666;
            color: #fff;
        }
        
        .svg-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        div {
            max-width: 100%;
        }
        svg {
            width: 100px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SVG Explorer</h1>
        </div>
        <div class="content">
            <div>
                <select class="svg-type" onchange="show_svgs(this)">
                    <option value="">------</option>
                </select>
                <select class="svg-color" onchange="set_fill_color(this)">
                    <option value="#FFFFFF">Blanco</option>
                    <option value="#000000">Negro</option>
                    <option value="#F0F0F0">Stone</option>
                    <option value="#FAC306">Kind Yellow</option>
                    <option value="#2FAD69">Jade</option>
                    <option value="#BE0059">Rose Red</option>
                    <option value="#2F7EB6">Steel Blue</option>
                    <option value="#E83323">Chili Red</option>
                </select>
                <label for="background-color">Background Color:</label>
                <select name="background-color" class="background-color" onchange="set_background(this)">
                    <option value="#666">Gris</option>
                    <option value="black">Negro</option>
                    <option value="white">Blanco</option>
                </select>
            </div>
            <div class="svg-container"></div>
        </div>
    </div>
    <script>
        var svg_type_select = document.querySelector('.svg-type');
        var svg_color_select = document.querySelector('.svg-color');

        function set_background(select){
            let font_color = 'white';
            if(select.value == 'white')
                font_color = 'black';

            document.querySelector('body').style = `background-color:${select.value}; color:${font_color}`;
        }

        function xmlToJson(xml) {
            if (typeof xml === 'string') {
                parser = new DOMParser();
                xml = parser.parseFromString(xml, 'text/xml');
            }
        
            // Create the return object
            var obj = {};
        
            if (xml.nodeType == 1) {
                // element
                // do attributes
                if (xml.attributes.length > 0) {
                    obj['@attributes'] = {};
                    for (var j = 0; j < xml.attributes.length; j++) {
                        var attribute = xml.attributes.item(j);
                        obj['@attributes'][attribute.nodeName] = attribute.nodeValue;
                    }
                }
            } else if (xml.nodeType == 3) {
                // text
                obj = xml.nodeValue;
            }
        
            // do children
            // If just one text node inside
            if (xml.hasChildNodes() && xml.childNodes.length === 1 && xml.childNodes[0].nodeType === 3) {
                obj = xml.childNodes[0].nodeValue;
            } else if (xml.hasChildNodes()) {
                for (var i = 0; i < xml.childNodes.length; i++) {
                    var item = xml.childNodes.item(i);
                    var nodeName = item.nodeName;
                    // camelCase
                    nodeName = nodeName.charAt(0).toLowerCase() + nodeName.slice(1);
                    if (typeof obj[nodeName] == 'undefined') {
                        obj[nodeName] = xmlToJson(item);
                    } else {
                        if (typeof obj[nodeName].push == 'undefined') {
                            var old = obj[nodeName];
                            obj[nodeName] = [];
                            obj[nodeName].push(old);
                        }
                        obj[nodeName].push(xmlToJson(item));
                    }
                }
            }
            return obj;
        }
        
        function getIndexUrl(prefix) {
            let bucket = 'youth-svgs';
            let region = 'eu-west-1';
            return 'https://s3.' + region + '.amazonaws.com/' + bucket + '/?delimiter=/&prefix=' + prefix;
        }

        function get_s3_url(key){
            let bucket = 'youth-svgs';
            let region = 'eu-west-1';
            return 'https://s3.' + region + '.amazonaws.com/' + bucket + '/' + key;
        }
        
        function getIndexJson(xml) {
            var json = xmlToJson(xml);
            var list = [];
            if (json.listBucketResult.commonPrefixes)
                list = list.concat(json.listBucketResult.commonPrefixes);
            if (json.listBucketResult.contents)
                list = list.concat(json.listBucketResult.contents);
        
            return list;
        }
        
        function show_svgs(element){
            let svg_type = element.value;
            
            // hide all containers of svgs
            document.querySelectorAll('.svg-container div').forEach(div => div.style = 'display: none;');
            if (svg_type == '')
                return;
            // show selected svgs
            let svg_containers = document.querySelectorAll(`.${svg_type}, .${svg_type} div`);
            for(let div of svg_containers){
                div.style = '';
                if (div.querySelector('svg') != null)
                    continue;

                let prefix = div.getAttribute('prefix');
                fetch(getIndexUrl(prefix))
                .then(response => response.text())
                .then(getIndexJson)
                .then(json_response => {
                    for (let dict of json_response){
                        if('key' in dict){
                            inject_svg(get_s3_url(dict['key']), div);
                        }
                    }
                })
            }
            svg_containers[0].parentElement.style = '';
        }

        function set_fill_color(element){
            let color = element.value;
            document.querySelectorAll('svg path').forEach(path => path.style = `fill: ${color}`);
        }

        function inject_svg(url, container){
            fetch(url)
            .then(response => response.text())
            .then(text => {
                var parser = new DOMParser();
                var xmlDoc = parser.parseFromString(text, "text/xml");

                // Get the SVG tag, ignore the rest
                var svg = xmlDoc.getElementsByTagName('svg')[0];

                // Remove any invalid XML tags as per http://validator.w3.org
                svg.removeAttribute('xmlns:a');
                svg.querySelector('path').style = `fill: ${svg_color_select.value}`;
                container.appendChild(svg);
            });
        }
    </script>
    <script type="module">
        let svg_container = document.querySelector('.svg-container');

        function explore_s3(prefix, container){
            return fetch(getIndexUrl(prefix))
            .then(response => response.text())
            .then(getIndexJson)
            .then(json_response => {
                for (let dict of json_response){
                    if('prefix' in dict){
                        let option = document.createElement('option');
                        option.value = dict['prefix'].replaceAll('/', '_');
                        option.innerHTML = dict['prefix'];
                        svg_type_select.add(option);

                        let div = document.createElement('div');
                        div.classList.add(dict['prefix'].replaceAll('/', '_'));
                        div.setAttribute('prefix', dict['prefix']);
                        let h2 = document.createElement('h2');
                        h2.innerHTML = dict['prefix'];
                        div.appendChild(h2);
                        container.appendChild(div);
                        explore_s3(dict['prefix'], div);
                    }
                }
            })
        }

        await explore_s3('', document.querySelector('.svg-container'));
        show_svgs(svg_type_select);
    </script>
</body>
</html>